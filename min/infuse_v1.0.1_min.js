/* infuse.js - v1.0.1 - 2016-01-13 - https://github.com/soundstep/infuse.js - http://www.soundstep.com */!function(a){"use strict";function b(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1}a.version="1.0.1";var c=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,d=/,/,e=/^\s*(_?)(\S+?)\1\s*$/,f=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm;a.errors={MAPPING_BAD_PROP:"[Error infuse.Injector.mapClass/mapValue] the first parameter is invalid, a string is expected",MAPPING_BAD_VALUE:"[Error infuse.Injector.mapClass/mapValue] the second parameter is invalid, it can't null or undefined, with property: ",MAPPING_BAD_CLASS:"[Error infuse.Injector.mapClass/mapValue] the second parameter is invalid, a function is expected, with property: ",MAPPING_BAD_SINGLETON:"[Error infuse.Injector.mapClass] the third parameter is invalid, a boolean is expected, with property: ",MAPPING_ALREADY_EXISTS:"[Error infuse.Injector.mapClass/mapValue] this mapping already exists, with property: ",CREATE_INSTANCE_INVALID_PARAM:"[Error infuse.Injector.createInstance] invalid parameter, a function is expected",NO_MAPPING_FOUND:"[Error infuse.Injector.getInstance] no mapping found",INJECT_INSTANCE_IN_ITSELF_PROPERTY:"[Error infuse.Injector.getInjectedValue] A matching property has been found in the target, you can't inject an instance in itself",INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR:"[Error infuse.Injector.getInjectedValue] A matching constructor parameter has been found in the target, you can't inject an instance in itself",DEPENDENCIES_MISSING_IN_STRICT_MODE:'[Error infuse.Injector.getDependencies] An "inject" property (array) that describes the dependencies is missing in strict mode.'};var g=function(a,b,c,d){this.prop=a,this.value=b,this.cl=c,this.singleton=d||!1},h=function(b){if("string"!=typeof b)throw new Error(a.errors.MAPPING_BAD_PROP)},i=function(b,c){if(void 0===c||null===c)throw new Error(a.errors.MAPPING_BAD_VALUE+b)},j=function(b,c){if("function"!=typeof c)throw new Error(a.errors.MAPPING_BAD_CLASS+b)},k=function(b,c){if("boolean"!=typeof c)throw new Error(a.errors.MAPPING_BAD_SINGLETON+b)},l=function(c,d){var e=a.getDependencies(d);if(b(e,c))throw new Error(a.errors.INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR)},m=function(b,c){if(c.hasOwnProperty(b))throw new Error(a.errors.INJECT_INSTANCE_IN_ITSELF_PROPERTY)};a.Injector=function(){this.mappings={},this.parent=null,this.strictMode=!1,this.throwOnMissing=!0},a.getDependencies=function(a){function b(a,b,c){h.push(c)}var g,h=[];a.hasOwnProperty("inject")&&"[object Array]"===Object.prototype.toString.call(a.inject)&&a.inject.length>0&&(g=a.inject);for(var i=a.toString().replace(f,""),j=i.match(c),k=j[1].split(d),l=0,m=k.length;m>l;l++){var n=g&&g[l]?g[l]:k[l];n.replace(e,b)}return h},a.Injector.prototype={createChild:function(){var b=new a.Injector;return b.parent=this,b.strictMode=this.strictMode,b.throwOnMissing=this.throwOnMissing,b},getMappingVo:function(a){return this.mappings?this.mappings[a]?this.mappings[a]:this.parent?this.parent.getMappingVo(a):null:null},mapValue:function(b,c){if(this.mappings[b])throw new Error(a.errors.MAPPING_ALREADY_EXISTS+b);return h(b),i(b,c),this.mappings[b]=new g(b,c,void 0,void 0),this},mapClass:function(b,c,d){if(this.mappings[b])throw new Error(a.errors.MAPPING_ALREADY_EXISTS+b);return h(b),j(b,c),d&&k(b,d),this.mappings[b]=new g(b,null,c,d),this},removeMapping:function(a){return this.mappings[a]=null,delete this.mappings[a],this},hasMapping:function(a){return!!this.mappings[a]},hasInheritedMapping:function(a){return!!this.getMappingVo(a)},getMapping:function(a){for(var b in this.mappings)if(this.mappings.hasOwnProperty(b)){var c=this.mappings[b];if(c.value===a||c.cl===a)return c.prop}return void 0},getValue:function(b){var c=this.mappings[b];if(!c){if(!this.parent)throw new Error(a.errors.NO_MAPPING_FOUND);c=this.parent.getMappingVo.apply(this.parent,arguments)}if(c.cl){var d=Array.prototype.slice.call(arguments);return d[0]=c.cl,c.singleton?(c.value||(c.value=this.createInstance.apply(this,d)),c.value):this.createInstance.apply(this,d)}return c.value},getClass:function(a){var b=this.mappings[a];if(!b){if(!this.parent)return void 0;b=this.parent.getMappingVo.apply(this.parent,arguments)}return b.cl?b.cl:void 0},instantiate:function(b){if("function"!=typeof b)throw new Error(a.errors.CREATE_INSTANCE_INVALID_PARAM);if(this.strictMode&&!b.hasOwnProperty("inject"))throw new Error(a.errors.DEPENDENCIES_MISSING_IN_STRICT_MODE);for(var c=[null],d=a.getDependencies(b),e=0,f=d.length;f>e;e++)if(arguments.length>e+1&&void 0!==arguments[e+1]&&null!==arguments[e+1])c.push(arguments[e+1]);else{var g=d[e],h=this.getMappingVo(g);if(h){var i=this.getInjectedValue(h,g);c.push(i)}else{if(this.throwOnMissing)throw new Error(a.errors.NO_MAPPING_FOUND+' for dependency "'+g+'" when instantiating "'+b.name+'"');c.push(void 0)}}return new(Function.prototype.bind.apply(b,c))},inject:function(a,b){this.parent&&this.parent.inject(a,!0);for(var c in this.mappings)if(this.mappings.hasOwnProperty(c)){var d=this.getMappingVo(c);(a.hasOwnProperty(d.prop)||a.constructor&&a.constructor.prototype&&a.constructor.prototype.hasOwnProperty(d.prop))&&(a[c]=this.getInjectedValue(d,c))}return"function"!=typeof a.postConstruct||b||a.postConstruct(),this},getInjectedValue:function(a,b){var c,d=a.value;return a.cl&&(a.singleton?(a.value||(l(b,a.cl),a.value=this.instantiate(a.cl),c=a.value),d=a.value):(l(b,a.cl),d=this.instantiate(a.cl),c=d)),c&&(m(b,c),this.inject(c)),d},createInstance:function(){var a=this.instantiate.apply(this,arguments);return this.inject(a),a},getValueFromClass:function(b){for(var c in this.mappings)if(this.mappings.hasOwnProperty(c)){var d=this.mappings[c];if(d.cl===b)return d.singleton?(d.value||(d.value=this.createInstance.apply(this,arguments)),d.value):this.createInstance.apply(this,arguments)}if(this.parent)return this.parent.getValueFromClass.apply(this.parent,arguments);throw new Error(a.errors.NO_MAPPING_FOUND)},dispose:function(){this.mappings={}}},Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;if("function"!=typeof b)throw new Error("Error, you must bind a function.");var c=Array.prototype.slice.call(arguments,1),d=function(){if(this instanceof d){var e=function(){};e.prototype=b.prototype;var f=new e,g=b.apply(f,c.concat(Array.prototype.slice.call(arguments)));return Object(g)===g?g:f}return b.apply(a,c.concat(Array.prototype.slice.call(arguments)))};return d}),"function"==typeof define&&"undefined"!=typeof define.amd&&define("infuse",a),"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports=a),"undefined"!=typeof exports&&(exports=a)}(this.infuse=this.infuse||{});